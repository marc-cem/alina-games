<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Math by Colour</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Fredoka', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Floating decorations */
        .decoration {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            font-size: 2rem;
            opacity: 0.6;
            animation: float 6s ease-in-out infinite;
        }

        .decoration:nth-child(1) { top: 5%; left: 5%; animation-delay: 0s; }
        .decoration:nth-child(2) { top: 15%; right: 8%; animation-delay: 1s; font-size: 2.5rem; }
        .decoration:nth-child(3) { top: 70%; left: 3%; animation-delay: 2s; }
        .decoration:nth-child(4) { top: 80%; right: 5%; animation-delay: 3s; font-size: 1.8rem; }
        .decoration:nth-child(5) { top: 45%; left: 2%; animation-delay: 4s; font-size: 2.2rem; }
        .decoration:nth-child(6) { top: 90%; right: 15%; animation-delay: 0.5s; }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-15px) rotate(5deg); }
            50% { transform: translateY(-8px) rotate(-3deg); }
            75% { transform: translateY(-20px) rotate(3deg); }
        }

        .game-container {
            background: linear-gradient(145deg, #ffffff 0%, #fff5f5 100%);
            border-radius: 30px;
            padding: 30px;
            padding-top: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 4px rgba(255,255,255,0.3);
            text-align: center;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff, #5f27cd);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbow 4s linear infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h2 {
            color: #5f27cd;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .subtitle {
            color: #888;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3em;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover, .btn:active {
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-success:hover {
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.5);
        }

        .btn-small {
            padding: 10px 25px;
            font-size: 1em;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        /* Level Select */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .level-btn {
            aspect-ratio: 1;
            border-radius: 18px;
            border: 3px solid #ddd;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Fredoka', sans-serif;
            color: #764ba2;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .level-btn.unlocked {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .level-btn.unlocked:hover {
            transform: scale(1.15) rotate(-3deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border-color: #f093fb;
        }

        .level-btn.locked {
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            color: #ccc;
            cursor: not-allowed;
        }

        .level-btn .stars {
            font-size: 0.5em;
            margin-top: 5px;
        }

        /* Question Screen */
        .question-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .question-counter {
            color: #888;
            font-size: 1.1em;
        }

        .colours-to-unlock {
            color: #5f27cd;
            font-size: 1em;
            font-weight: 500;
        }

        .question-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            padding: 40px;
            border-radius: 24px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .question-box::before {
            content: '‚ú®';
            position: absolute;
            top: 10px;
            left: 15px;
            font-size: 1.5rem;
            animation: twinkle 2s ease-in-out infinite;
        }

        .question-box::after {
            content: '‚≠ê';
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 1.5rem;
            animation: twinkle 2s ease-in-out infinite 0.5s;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .question-text {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .answer-input {
            font-size: 2em;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            padding: 15px 30px;
            border-radius: 20px;
            border: 4px solid #ddd;
            width: 150px;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .answer-input:focus {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }

        .submit-btn {
            display: block;
            width: 100%;
            margin-top: 20px;
        }

        .progress-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .progress-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #888;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: white;
        }

        .progress-dot.current {
            border-color: #667eea;
            color: #667eea;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 25px rgba(102, 126, 234, 0.6); }
        }

        .progress-dot.correct {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            border-color: #4CAF50;
            color: white;
            transform: scale(1.05);
        }

        .progress-dot.wrong {
            background: linear-gradient(135deg, #f44336, #ff5722);
            border-color: #f44336;
            color: white;
        }

        .colour-preview {
            display: inline-block;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            margin: 10px;
            animation: colorPulse 2s ease-in-out infinite;
        }

        @keyframes colorPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
            50% { transform: scale(1.1); box-shadow: 0 8px 30px rgba(0,0,0,0.35); }
        }

        .unlock-text {
            font-size: 1.2em;
            margin-top: 10px;
            font-weight: 500;
        }

        .timer-bar {
            height: 12px;
            background: #eee;
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.1s linear;
            border-radius: 6px;
        }

        .timer-fill.warning {
            background: linear-gradient(90deg, #ff9800, #ffc107);
        }

        .timer-fill.danger {
            background: linear-gradient(90deg, #f44336, #ff5722);
        }

        /* Colouring Screen */
        .colouring-area {
            position: relative;
            margin: 20px 0;
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .colouring-area svg {
            width: 100%;
            max-height: 350px;
        }

        .colour-palette {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
            min-height: 70px;
        }

        .colour-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: 4px solid #ddd;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .colour-btn:hover {
            transform: scale(1.15);
        }

        .colour-btn.selected {
            transform: scale(1.25);
            border-color: #333;
            box-shadow: 0 8px 25px rgba(0,0,0,0.35);
        }

        .colour-btn.used {
            animation: colourUsed 0.5s ease-out forwards;
        }

        @keyframes colourUsed {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; display: none; }
        }

        .colour-btn .number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            font-size: 1.3em;
        }

        .svg-region {
            stroke: #333;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s;
            fill: white;
        }

        .svg-region:hover {
            opacity: 0.8;
            filter: brightness(1.1);
        }

        .svg-region.filled {
            cursor: default;
        }

        .region-number {
            font-size: 20px;
            font-weight: bold;
            fill: #666;
            pointer-events: none;
        }

        .region-number.hidden {
            display: none;
        }

        /* Celebration */
        .celebration {
            animation: celebrate 0.5s ease-out;
        }

        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .stars-display {
            font-size: 4em;
            margin: 20px 0;
        }

        .stars-display .star {
            color: #ddd;
            transition: color 0.3s;
            display: inline-block;
        }

        .stars-display .star.earned {
            color: #ffc107;
            animation: starPop 0.5s ease-out;
            text-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        }

        @keyframes starPop {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.4) rotate(20deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .completed-image {
            border: 6px solid #ffc107;
            border-radius: 24px;
            padding: 15px;
            background: white;
            box-shadow: 0 8px 30px rgba(255, 193, 7, 0.3);
        }

        /* Feedback overlay */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .feedback-overlay.show {
            opacity: 1;
        }

        .feedback-icon {
            font-size: 150px;
            animation: feedbackPop 0.5s ease-out;
            text-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        @keyframes feedbackPop {
            0% { transform: scale(0) rotate(-20deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .mistakes-counter {
            color: #888;
            font-size: 1em;
            margin-top: 10px;
        }

        .picture-name {
            color: #5f27cd;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* All done message */
        .all-coloured-msg {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            margin: 15px 0;
            font-size: 1.2em;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .all-coloured-msg.warning {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .reset-link {
            color: #999;
            font-size: 0.9em;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 20px;
            display: inline-block;
            transition: color 0.3s;
        }

        .reset-link:hover {
            color: #5f27cd;
        }

        .home-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #5f27cd;
            text-decoration: none;
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 15px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(95, 39, 205, 0.1);
            transition: all 0.3s ease;
        }

        .home-link:hover {
            background: rgba(95, 39, 205, 0.2);
            transform: translateX(-5px);
        }

        /* Navigation buttons */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.95em;
            font-family: 'Fredoka', sans-serif;
            font-weight: 500;
            background: rgba(95, 39, 205, 0.1);
            color: #5f27cd;
            border: none;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(95, 39, 205, 0.2);
            transform: scale(1.05);
        }

        /* Colour dot on level buttons */
        .colour-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .colour-dot.locked {
            background: #ccc;
            border: 2px dashed #999;
        }

        /* Welcome screen decorations */
        .welcome-star {
            animation: wiggle 3s ease-in-out infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* Responsive */
        @media (max-width: 500px) {
            .game-container {
                padding: 20px;
                border-radius: 24px;
            }

            h1 {
                font-size: 2em;
            }

            .question-text {
                font-size: 2.5em;
            }

            .level-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .progress-dot {
                width: 32px;
                height: 32px;
                font-size: 0.8em;
            }

            .decoration {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Floating decorations -->
    <div class="decoration">‚≠ê</div>
    <div class="decoration">üåà</div>
    <div class="decoration">‚ú®</div>
    <div class="decoration">üé®</div>
    <div class="decoration">ü¶ã</div>
    <div class="decoration">üéÄ</div>

    <div class="game-container">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <a href="../index.html" class="home-link">‚Üê Back to All Games</a>
            <h1>üé® Math by Colour</h1>
            <p class="subtitle">Let's colour by numbers! üåü</p>
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTc1IDEwbDIwIDQwaDQ1bC0zNSAzMCAxNSA0NS00NS0zMC00NSAzMCAxNS00NS0zNS0zMGg0NXoiIGZpbGw9IiNmZmM1MDciIHN0cm9rZT0iI2ZmYTAwMCIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+" alt="Star" class="welcome-star" style="width: 150px; margin: 20px 0;">
            <p style="color: #666; margin-bottom: 30px;">Answer math questions to unlock colours<br>and create beautiful pictures!</p>
            <button class="btn" onclick="showScreen('level-screen')">Let's Play! üöÄ</button>
            <br>
            <span class="reset-link" onclick="confirmReset()">Reset Progress</span>
        </div>

        <!-- Level Select Screen -->
        <div id="level-screen" class="screen">
            <div class="nav-bar">
                <button class="nav-btn" onclick="showScreen('welcome-screen')">‚Üê Back</button>
                <a href="../index.html" class="nav-btn">üè†</a>
            </div>
            <h2>Choose a Level</h2>
            <div class="level-grid" id="level-grid"></div>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="screen">
            <div class="nav-bar">
                <button class="nav-btn" onclick="confirmLeaveLevel()">‚Üê Levels</button>
                <a href="../index.html" class="nav-btn">üè†</a>
            </div>
            <h2>Level <span id="current-level">1</span></h2>
            <div class="picture-name" id="picture-name">Star</div>
            <div class="question-info">
                <span class="question-counter">Question <span id="question-num">1</span> of 5</span>
                <span class="colours-to-unlock" id="colours-to-unlock">üé® 1 colour to unlock</span>
            </div>
            <div class="progress-bar" id="progress-bar"></div>
            <div id="timer-container" style="display: none;">
                <div class="timer-bar">
                    <div class="timer-fill" id="timer-fill"></div>
                </div>
            </div>
            <div class="question-box">
                <div class="question-text" id="question-text">3 + 5 = ?</div>
                <div id="colour-preview-container">
                    <div class="colour-preview" id="colour-preview"></div>
                    <div class="unlock-text">Answer correctly to unlock this colour!</div>
                </div>
                <div id="all-unlocked-msg" style="display: none;">
                    <p style="font-size: 1.2em; margin-top: 10px;">‚ú® All colours unlocked! Keep going for more stars! ‚ú®</p>
                </div>
            </div>
            <input type="number" class="answer-input" id="answer-input" placeholder="?" inputmode="numeric">
            <button class="btn submit-btn" onclick="submitAnswer()">Check Answer ‚úì</button>
            <div class="mistakes-counter" id="mistakes-counter">Mistakes: 0</div>
        </div>

        <!-- Colouring Screen -->
        <div id="colouring-screen" class="screen">
            <div class="nav-bar">
                <button class="nav-btn" onclick="showScreen('level-screen')">‚Üê Levels</button>
                <a href="../index.html" class="nav-btn">üè†</a>
            </div>
            <h2>Colour Your Picture! üé®</h2>
            <div class="picture-name" id="colouring-picture-name">Star</div>
            <div class="colouring-area" id="colouring-area"></div>
            <div class="colour-palette" id="colour-palette"></div>
            <div id="all-coloured-container"></div>
            <button class="btn btn-success" id="done-btn" onclick="finishColouring()" style="display: none;">Done! ‚ú®</button>
        </div>

        <!-- Celebration Screen -->
        <div id="celebration-screen" class="screen">
            <div class="nav-bar">
                <span></span>
                <a href="../index.html" class="nav-btn">üè†</a>
            </div>
            <div class="celebration">
                <h2>Amazing Work! üéâ</h2>
                <div class="stars-display" id="stars-display">
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                </div>
                <div class="completed-image" id="completed-image"></div>
                <p style="margin: 20px 0; color: #666;" id="completion-message"></p>
                <button class="btn" onclick="saveImage()">Save Picture üì∏</button>
                <button class="btn btn-success" onclick="nextLevel()">Next Level ‚Üí</button>
                <button class="btn btn-secondary" onclick="showScreen('level-screen')">Level Select</button>
            </div>
        </div>
    </div>

    <!-- Feedback Overlay -->
    <div class="feedback-overlay" id="feedback-overlay">
        <div class="feedback-icon" id="feedback-icon">‚úì</div>
    </div>

    <script>
        // Game State
        let currentLevel = 1;
        let currentQuestion = 0;
        let mistakes = 0;
        let correctAnswers = 0;
        let sessionUnlockedColour = false; // Did we unlock this level's colour in current session?
        let selectedColour = null;
        let timerInterval = null;
        let timeLeft = 15;
        let askedQuestions = new Set();
        let availableColours = [];
        let questionResults = [];
        let regionFillCount = {}; // Track how many regions of each number are filled

        // Progress storage - includes permanent palette
        let gameProgress = JSON.parse(localStorage.getItem('mathByColour_progress_v2') || '{"levelProgress": {}, "permanentPalette": []}');
        let levelProgress = gameProgress.levelProgress;
        let permanentPalette = gameProgress.permanentPalette; // Array of unlocked colour indices (0-14)

        function saveProgress() {
            gameProgress.levelProgress = levelProgress;
            gameProgress.permanentPalette = permanentPalette;
            localStorage.setItem('mathByColour_progress_v2', JSON.stringify(gameProgress));
        }

        // Audio Context for sound effects
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
        }

        function playSound(type) {
            initAudio();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.4);
            } else if (type === 'wrong') {
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'complete') {
                const notes = [523.25, 587.33, 659.25, 783.99, 880, 1046.5];
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.1);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime + i * 0.1);
                    gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.1 + 0.2);
                    osc.start(audioCtx.currentTime + i * 0.1);
                    osc.stop(audioCtx.currentTime + i * 0.1 + 0.2);
                });
            } else if (type === 'paint') {
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.1);
            }
        }

        // Reset game progress
        function confirmReset() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
                localStorage.removeItem('mathByColour_progress_v2');
                localStorage.removeItem('mathByColour_progress'); // Clean up old format
                levelProgress = {};
                permanentPalette = [];
                gameProgress = { levelProgress: {}, permanentPalette: [] };
                renderLevelGrid();
                alert('Progress has been reset! üîÑ');
            }
        }

        // Leave level confirmation
        function confirmLeaveLevel() {
            if (confirm('Leave level? Your progress will be lost.')) {
                if (timerInterval) clearInterval(timerInterval);
                showScreen('level-screen');
            }
        }

        // Master Colour Palette - colours unlock progressively
        const MASTER_PALETTE = [
            { name: "Red", hex: "#FF3B30" },
            { name: "Yellow", hex: "#FFD700" },
            { name: "Green", hex: "#4CD964" },
            { name: "Blue", hex: "#4A90D9" },
            { name: "Orange", hex: "#FF8C00" },
            { name: "Pink", hex: "#FF69B4" },
            { name: "Brown", hex: "#8B4513" },
            { name: "Purple", hex: "#9B59B6" },
            { name: "Cyan", hex: "#00CED1" },
            { name: "Tan", hex: "#DEB887" },
            { name: "Gold", hex: "#DAA520" },
            { name: "Silver", hex: "#A8A8A8" },
            { name: "Cream", hex: "#FFF8DC" },
            { name: "Crimson", hex: "#DC143C" },
            { name: "Lime", hex: "#32CD32" }
        ];

        // Pictures Library - Level N uses exactly N colours (regions 1 through N)
        const pictures = [
            // Level 1: Heart - 1 region (Red)
            {
                name: "Heart",
                svg: `<svg viewBox="0 0 200 200">
                    <path class="svg-region" data-region="1" d="M100 180 C20 100 20 40 70 30 C90 26 100 45 100 45 C100 45 110 26 130 30 C180 40 180 100 100 180 Z" fill="white"/>
                    <text class="region-number" x="100" y="100">1</text>
                </svg>`
            },
            // Level 2: Flower - 2 regions (Red petals, Yellow center)
            {
                name: "Flower",
                svg: `<svg viewBox="0 0 200 200">
                    <circle class="svg-region" data-region="1" cx="100" cy="60" r="30" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="140" cy="85" r="30" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="130" cy="135" r="30" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="70" cy="135" r="30" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="60" cy="85" r="30" fill="white"/>
                    <circle class="svg-region" data-region="2" cx="100" cy="100" r="25" fill="white"/>
                    <text class="region-number" x="100" y="45">1</text>
                    <text class="region-number" x="150" y="85">1</text>
                    <text class="region-number" x="140" y="145">1</text>
                    <text class="region-number" x="60" y="145">1</text>
                    <text class="region-number" x="50" y="85">1</text>
                    <text class="region-number" x="100" y="100">2</text>
                </svg>`
            },
            // Level 3: Apple - 3 regions (Red body, Yellow highlight, Green leaf)
            {
                name: "Apple",
                svg: `<svg viewBox="0 0 200 200">
                    <path class="svg-region" data-region="1" d="M100 180 C60 180 30 160 30 110 C30 60 60 40 100 60 C140 40 170 60 170 110 C170 160 140 180 100 180 Z" fill="white"/>
                    <path class="svg-region" data-region="3" d="M100 60 Q100 20 130 20 Q130 50 100 60" fill="white"/>
                    <path d="M100 60 Q95 40 90 30" style="fill:none; stroke:#333; stroke-width:4px"/>
                    <path class="svg-region" data-region="2" d="M130 80 Q145 80 150 100 Q145 120 130 120 Q120 100 130 80 Z" fill="white"/>
                    <text class="region-number" x="80" y="120">1</text>
                    <text class="region-number" x="138" y="100">2</text>
                    <text class="region-number" x="115" y="40">3</text>
                </svg>`
            },
            // Level 4: Fish - 4 regions (Red fins, Yellow stripe, Green seaweed, Blue body)
            {
                name: "Fish",
                svg: `<svg viewBox="0 0 200 200">
                    <path class="svg-region" data-region="1" d="M160 100 L190 70 L190 130 Z" fill="white"/>
                    <path class="svg-region" data-region="1" d="M90 60 L110 30 L130 65" fill="white"/>
                    <path class="svg-region" data-region="1" d="M90 140 L110 170 L130 135" fill="white"/>
                    <ellipse class="svg-region" data-region="4" cx="100" cy="100" rx="70" ry="45" fill="white"/>
                    <path class="svg-region" data-region="2" d="M100 55 Q120 100 100 145 Q80 100 100 55 Z" fill="white"/>
                    <path class="svg-region" data-region="3" d="M30 190 Q30 150 40 170 T50 190" style="fill:none; stroke:#333; stroke-width:3px"/>
                    <path class="svg-region" data-region="3" d="M10 190 Q10 140 25 160 T40 190" style="fill:none; stroke:#333; stroke-width:3px"/>
                    <path class="svg-region" data-region="3" d="M160 190 Q160 160 170 180 T180 190" style="fill:none; stroke:#333; stroke-width:3px"/>
                    <circle cx="60" cy="90" r="5" fill="#333" stroke="none"/>
                    <text class="region-number" x="175" y="100">1</text>
                    <text class="region-number" x="110" y="45">1</text>
                    <text class="region-number" x="110" y="155">1</text>
                    <text class="region-number" x="100" y="100">2</text>
                    <text class="region-number" x="30" y="170">3</text>
                    <text class="region-number" x="135" y="100">4</text>
                </svg>`
            },
            // Level 5: Butterfly - 5 regions
            {
                name: "Butterfly",
                svg: `<svg viewBox="0 0 200 200">
                    <path class="svg-region" data-region="5" d="M90 80 C40 30 10 50 20 100 C50 110 90 100 90 100" fill="white"/>
                    <path class="svg-region" data-region="5" d="M110 80 C160 30 190 50 180 100 C150 110 110 100 110 100" fill="white"/>
                    <path class="svg-region" data-region="4" d="M92 105 C50 160 30 150 40 120 C45 110 90 100 92 105" fill="white"/>
                    <path class="svg-region" data-region="4" d="M108 105 C150 160 170 150 160 120 C155 110 110 100 108 105" fill="white"/>
                    <ellipse class="svg-region" data-region="2" cx="100" cy="100" rx="10" ry="50" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="50" cy="70" r="10" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="150" cy="70" r="10" fill="white"/>
                    <path class="svg-region" data-region="3" d="M100 160 Q130 160 130 180 Q100 200 70 180 Q70 160 100 160" fill="white"/>
                    <path d="M95 55 L80 30" style="fill:none; stroke:#333; stroke-width:2px"/>
                    <path d="M105 55 L120 30" style="fill:none; stroke:#333; stroke-width:2px"/>
                    <text class="region-number" x="50" y="70">1</text>
                    <text class="region-number" x="150" y="70">1</text>
                    <text class="region-number" x="100" y="100">2</text>
                    <text class="region-number" x="100" y="180">3</text>
                    <text class="region-number" x="60" y="125">4</text>
                    <text class="region-number" x="140" y="125">4</text>
                    <text class="region-number" x="50" y="45">5</text>
                    <text class="region-number" x="150" y="45">5</text>
                </svg>`
            },
            // Level 6: Tulip in Pot - 6 regions
            {
                name: "Tulip",
                svg: `<svg viewBox="0 0 200 200">
                    <rect class="svg-region" data-region="3" x="95" y="90" width="10" height="50" fill="white"/>
                    <path class="svg-region" data-region="3" d="M100 130 Q140 100 140 80 Q120 120 105 130" fill="white"/>
                    <path class="svg-region" data-region="5" d="M60 140 L50 180 L150 180 L140 140 Z" fill="white"/>
                    <rect class="svg-region" data-region="4" x="55" y="125" width="90" height="15" rx="3" fill="white"/>
                    <path class="svg-region" data-region="1" d="M100 95 C60 95 60 40 100 40 C140 40 140 95 100 95 Z" fill="white"/>
                    <ellipse class="svg-region" data-region="2" cx="100" cy="65" rx="15" ry="25" fill="white"/>
                    <path class="svg-region" data-region="6" d="M100 150 L80 140 L80 160 Z" fill="white"/>
                    <path class="svg-region" data-region="6" d="M100 150 L120 140 L120 160 Z" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="100" cy="150" r="5" fill="white"/>
                    <text class="region-number" x="80" y="70">1</text>
                    <text class="region-number" x="120" y="70">1</text>
                    <text class="region-number" x="100" y="65">2</text>
                    <text class="region-number" x="92" y="115">3</text>
                    <text class="region-number" x="130" y="100">3</text>
                    <text class="region-number" x="100" y="133">4</text>
                    <text class="region-number" x="100" y="165">5</text>
                    <text class="region-number" x="125" y="150">6</text>
                </svg>`
            },
            // Level 7: House - 7 regions
            {
                name: "House",
                svg: `<svg viewBox="0 0 200 200">
                    <rect class="svg-region" data-region="4" x="10" y="10" width="180" height="80" fill="white"/>
                    <rect class="svg-region" data-region="5" x="140" y="40" width="20" height="40" fill="white"/>
                    <path class="svg-region" data-region="7" d="M20 90 L100 30 L180 90 Z" fill="white"/>
                    <rect x="30" y="90" width="140" height="80" fill="none" stroke="#333" stroke-width="2"/>
                    <rect class="svg-region" data-region="1" x="85" y="120" width="30" height="50" fill="white"/>
                    <rect class="svg-region" data-region="2" x="45" y="110" width="25" height="25" fill="white"/>
                    <rect class="svg-region" data-region="2" x="130" y="110" width="25" height="25" fill="white"/>
                    <rect class="svg-region" data-region="3" x="10" y="170" width="180" height="20" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="40" cy="160" r="8" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="160" cy="160" r="8" fill="white"/>
                    <text class="region-number" x="100" y="145">1</text>
                    <text class="region-number" x="58" y="123">2</text>
                    <text class="region-number" x="143" y="123">2</text>
                    <text class="region-number" x="100" y="180">3</text>
                    <text class="region-number" x="30" y="30">4</text>
                    <text class="region-number" x="150" y="50">5</text>
                    <text class="region-number" x="40" y="160">6</text>
                    <text class="region-number" x="160" y="160">6</text>
                    <text class="region-number" x="100" y="65">7</text>
                </svg>`
            },
            // Level 8: Cat - 8 regions
            {
                name: "Cat",
                svg: `<svg viewBox="0 0 200 200">
                    <path class="svg-region" data-region="7" d="M140 145 Q180 145 180 100 Q180 70 150 70 L150 90 Q160 90 160 100 Q160 125 140 125 Z" fill="white"/>
                    <path class="svg-region" data-region="5" d="M60 170 L60 120 Q60 80 100 80 Q140 80 140 120 L140 170 Z" fill="white"/>
                    <circle class="svg-region" data-region="5" cx="100" cy="70" r="35" fill="white"/>
                    <path class="svg-region" data-region="5" d="M70 50 L60 20 L90 40" fill="white"/>
                    <path class="svg-region" data-region="5" d="M130 50 L140 20 L110 40" fill="white"/>
                    <ellipse class="svg-region" data-region="2" cx="85" cy="65" rx="5" ry="7" fill="white"/>
                    <ellipse class="svg-region" data-region="2" cx="115" cy="65" rx="5" ry="7" fill="white"/>
                    <path class="svg-region" data-region="6" d="M95 75 L105 75 L100 82 Z" fill="white"/>
                    <rect class="svg-region" data-region="4" x="80" y="100" width="40" height="10" rx="2" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="100" cy="115" r="6" fill="white"/>
                    <path class="svg-region" data-region="8" d="M120 25 L130 15 L130 35 Z" fill="white"/>
                    <path class="svg-region" data-region="8" d="M120 25 L110 15 L110 35 Z" fill="white"/>
                    <circle class="svg-region" data-region="8" cx="120" cy="25" r="3" fill="white"/>
                    <rect class="svg-region" data-region="3" x="20" y="170" width="160" height="15" fill="white"/>
                    <text class="region-number" x="100" y="115" style="font-size:10px">1</text>
                    <text class="region-number" x="85" y="55" style="font-size:10px">2</text>
                    <text class="region-number" x="115" y="55" style="font-size:10px">2</text>
                    <text class="region-number" x="100" y="178">3</text>
                    <text class="region-number" x="115" y="105" style="font-size:10px">4</text>
                    <text class="region-number" x="100" y="145">5</text>
                    <text class="region-number" x="70" y="30">5</text>
                    <text class="region-number" x="100" y="85" style="font-size:8px">6</text>
                    <text class="region-number" x="165" y="100">7</text>
                    <text class="region-number" x="135" y="25" style="font-size:10px">8</text>
                </svg>`
            },
            // Level 9: Rocket - 9 regions
            {
                name: "Rocket",
                svg: `<svg viewBox="0 0 200 200">
                    <rect class="svg-region" data-region="8" x="10" y="10" width="180" height="180" rx="10" fill="white"/>
                    <path class="svg-region" data-region="4" d="M70 130 L50 160 L70 150 Z" fill="white"/>
                    <path class="svg-region" data-region="4" d="M130 130 L150 160 L130 150 Z" fill="white"/>
                    <path class="svg-region" data-region="7" d="M40 170 Q100 160 160 170 L160 180 L40 180 Z" fill="white"/>
                    <path class="svg-region" data-region="5" d="M90 150 L100 180 L110 150 Z" fill="white"/>
                    <path class="svg-region" data-region="1" d="M100 30 Q130 80 130 140 L130 150 L70 150 L70 140 Q70 80 100 30 Z" fill="white"/>
                    <circle class="svg-region" data-region="9" cx="100" cy="80" r="15" fill="white"/>
                    <rect class="svg-region" data-region="6" x="70" y="110" width="60" height="10" fill="white"/>
                    <circle class="svg-region" data-region="3" cx="160" cy="40" r="15" fill="white"/>
                    <path class="svg-region" data-region="2" d="M40 50 L42 45 L47 45 L43 42 L45 37 L40 40 L35 37 L37 42 L33 45 L38 45 Z" fill="white"/>
                    <path class="svg-region" data-region="2" d="M150 120 L152 115 L157 115 L153 112 L155 107 L150 110 L145 107 L147 112 L143 115 L148 115 Z" fill="white"/>
                    <text class="region-number" x="100" y="60">1</text>
                    <text class="region-number" x="30" y="30">2</text>
                    <text class="region-number" x="160" y="40">3</text>
                    <text class="region-number" x="60" y="150">4</text>
                    <text class="region-number" x="140" y="150">4</text>
                    <text class="region-number" x="100" y="170">5</text>
                    <text class="region-number" x="100" y="115">6</text>
                    <text class="region-number" x="130" y="175">7</text>
                    <text class="region-number" x="30" y="100">8</text>
                    <text class="region-number" x="100" y="80">9</text>
                </svg>`
            },
            // Level 10: Cupcake - 10 regions
            {
                name: "Cupcake",
                svg: `<svg viewBox="0 0 200 200">
                    <rect class="svg-region" data-region="10" x="10" y="170" width="180" height="20" fill="white"/>
                    <ellipse class="svg-region" data-region="9" cx="100" cy="170" rx="70" ry="10" fill="white"/>
                    <path class="svg-region" data-region="7" d="M60 100 L70 160 L130 160 L140 100 Z" fill="white"/>
                    <path class="svg-region" data-region="2" d="M70 100 L75 160 L90 160 L85 100 Z" fill="white"/>
                    <path class="svg-region" data-region="8" d="M115 100 L110 160 L125 160 L130 100 Z" fill="white"/>
                    <path class="svg-region" data-region="6" d="M50 100 Q40 60 100 50 Q160 60 150 100 Q125 115 100 110 Q75 115 50 100" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="100" cy="40" r="12" fill="white"/>
                    <path class="svg-region" data-region="3" d="M100 40 Q110 20 120 25" style="fill:none; stroke:#333; stroke-width:2px"/>
                    <rect class="svg-region" data-region="4" x="70" y="70" width="15" height="5" transform="rotate(20)" fill="white"/>
                    <circle class="svg-region" data-region="5" cx="130" cy="80" r="5" fill="white"/>
                    <text class="region-number" x="100" y="40">1</text>
                    <text class="region-number" x="80" y="130">2</text>
                    <text class="region-number" x="120" y="20">3</text>
                    <text class="region-number" x="75" y="65">4</text>
                    <text class="region-number" x="130" y="72">5</text>
                    <text class="region-number" x="100" y="80">6</text>
                    <text class="region-number" x="100" y="135">7</text>
                    <text class="region-number" x="120" y="130">8</text>
                    <text class="region-number" x="150" y="170">9</text>
                    <text class="region-number" x="170" y="180">10</text>
                </svg>`
            },
            // Level 11: Crown - 11 regions
            {
                name: "Crown",
                svg: `<svg viewBox="0 0 200 200">
                    <rect class="svg-region" data-region="10" x="10" y="10" width="180" height="180" fill="white"/>
                    <path class="svg-region" data-region="6" d="M40 150 Q100 120 160 150 L160 170 Q100 140 40 170 Z" fill="white"/>
                    <rect class="svg-region" data-region="5" x="50" y="120" width="100" height="30" fill="white"/>
                    <rect class="svg-region" data-region="7" x="50" y="145" width="100" height="5" fill="white"/>
                    <path class="svg-region" data-region="11" d="M50 120 L50 60 L80 90 L100 40 L120 90 L150 60 L150 120 Z" fill="white"/>
                    <rect class="svg-region" data-region="2" x="50" y="122" width="100" height="5" fill="white"/>
                    <path class="svg-region" data-region="8" d="M80 90 L100 70 L120 90 L100 110 Z" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="100" cy="55" r="8" fill="white"/>
                    <circle class="svg-region" data-region="3" cx="50" cy="60" r="6" fill="white"/>
                    <circle class="svg-region" data-region="4" cx="150" cy="60" r="6" fill="white"/>
                    <circle class="svg-region" data-region="9" cx="100" cy="135" r="8" fill="white"/>
                    <text class="region-number" x="100" y="55" style="font-size:10px">1</text>
                    <text class="region-number" x="155" y="125" style="font-size:10px">2</text>
                    <text class="region-number" x="50" y="60" style="font-size:10px">3</text>
                    <text class="region-number" x="150" y="60" style="font-size:10px">4</text>
                    <text class="region-number" x="70" y="135">5</text>
                    <text class="region-number" x="100" y="160">6</text>
                    <text class="region-number" x="130" y="147" style="font-size:8px">7</text>
                    <text class="region-number" x="100" y="90">8</text>
                    <text class="region-number" x="100" y="135" style="font-size:10px">9</text>
                    <text class="region-number" x="30" y="30">10</text>
                    <text class="region-number" x="135" y="80">11</text>
                </svg>`
            },
            // Level 12: Robot - 12 regions
            {
                name: "Robot",
                svg: `<svg viewBox="0 0 200 200">
                    <path class="svg-region" data-region="9" d="M30 100 Q10 120 30 140 L40 140 L40 100 Z" fill="white"/>
                    <path class="svg-region" data-region="9" d="M170 100 Q190 120 170 140 L160 140 L160 100 Z" fill="white"/>
                    <path class="svg-region" data-region="7" d="M60 170 L140 170 L150 190 L50 190 Z" fill="white"/>
                    <rect class="svg-region" data-region="12" x="50" y="90" width="100" height="80" rx="5" fill="white"/>
                    <rect class="svg-region" data-region="12" x="60" y="30" width="80" height="50" rx="5" fill="white"/>
                    <rect class="svg-region" data-region="10" x="90" y="80" width="20" height="10" fill="white"/>
                    <line x1="100" y1="30" x2="100" y2="10" stroke="#333" stroke-width="3"/>
                    <circle class="svg-region" data-region="2" cx="100" cy="10" r="5" fill="white"/>
                    <circle class="svg-region" data-region="1" cx="80" cy="50" r="8" fill="white"/>
                    <circle class="svg-region" data-region="3" cx="120" cy="50" r="8" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="70" cy="65" r="4" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="130" cy="65" r="4" fill="white"/>
                    <rect class="svg-region" data-region="8" x="70" y="35" width="60" height="10" fill="white"/>
                    <rect class="svg-region" data-region="4" x="70" y="100" width="60" height="30" rx="2" fill="white"/>
                    <circle class="svg-region" data-region="5" cx="80" cy="145" r="5" fill="white"/>
                    <circle class="svg-region" data-region="5" cx="100" cy="145" r="5" fill="white"/>
                    <circle class="svg-region" data-region="5" cx="120" cy="145" r="5" fill="white"/>
                    <path d="M130 110 L140 100 L140 120 Z" fill="white" stroke="#333" stroke-width="2"/>
                    <circle class="svg-region" data-region="11" cx="130" cy="155" r="8" fill="white"/>
                    <text class="region-number" x="80" y="50" style="font-size:10px">1</text>
                    <text class="region-number" x="115" y="10">2</text>
                    <text class="region-number" x="120" y="50" style="font-size:10px">3</text>
                    <text class="region-number" x="100" y="115">4</text>
                    <text class="region-number" x="100" y="145" style="font-size:10px">5</text>
                    <text class="region-number" x="140" y="65" style="font-size:10px">6</text>
                    <text class="region-number" x="100" y="180">7</text>
                    <text class="region-number" x="100" y="40" style="font-size:8px">8</text>
                    <text class="region-number" x="25" y="120">9</text>
                    <text class="region-number" x="115" y="85" style="font-size:10px">10</text>
                    <text class="region-number" x="130" y="155" style="font-size:10px">11</text>
                    <text class="region-number" x="140" y="130">12</text>
                </svg>`
            },
            // Level 13: Owl - 13 regions
            {
                name: "Owl",
                svg: `<svg viewBox="0 0 200 200">
                    <rect class="svg-region" data-region="4" x="10" y="10" width="180" height="40" rx="5" fill="white"/>
                    <circle class="svg-region" data-region="9" cx="160" cy="30" r="12" fill="white"/>
                    <circle class="svg-region" data-region="12" cx="30" cy="30" r="8" fill="white"/>
                    <circle class="svg-region" data-region="12" cx="50" cy="20" r="6" fill="white"/>
                    <ellipse class="svg-region" data-region="7" cx="100" cy="110" rx="50" ry="60" fill="white"/>
                    <path class="svg-region" data-region="8" d="M60 70 L50 40 L80 60" fill="white"/>
                    <path class="svg-region" data-region="8" d="M140 70 L150 40 L120 60" fill="white"/>
                    <circle class="svg-region" data-region="11" cx="80" cy="90" r="18" fill="white"/>
                    <circle class="svg-region" data-region="11" cx="120" cy="90" r="18" fill="white"/>
                    <circle class="svg-region" data-region="2" cx="80" cy="90" r="5" fill="white"/>
                    <circle class="svg-region" data-region="2" cx="120" cy="90" r="5" fill="white"/>
                    <path class="svg-region" data-region="5" d="M100 100 L90 115 L110 115 Z" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="60" cy="110" r="5" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="140" cy="110" r="5" fill="white"/>
                    <path class="svg-region" data-region="13" d="M75 130 Q100 160 125 130 Z" fill="white"/>
                    <ellipse class="svg-region" data-region="10" cx="80" cy="165" rx="8" ry="5" fill="white"/>
                    <ellipse class="svg-region" data-region="10" cx="120" cy="165" rx="8" ry="5" fill="white"/>
                    <rect class="svg-region" data-region="3" x="20" y="170" width="160" height="15" rx="5" fill="white"/>
                    <path class="svg-region" data-region="1" d="M100 170 L90 180 L90 160 Z" fill="white"/>
                    <path class="svg-region" data-region="1" d="M100 170 L110 180 L110 160 Z" fill="white"/>
                    <text class="region-number" x="100" y="170" style="font-size:10px">1</text>
                    <text class="region-number" x="80" y="85" style="font-size:8px">2</text>
                    <text class="region-number" x="150" y="178">3</text>
                    <text class="region-number" x="90" y="30">4</text>
                    <text class="region-number" x="100" y="110" style="font-size:8px">5</text>
                    <text class="region-number" x="55" y="105" style="font-size:8px">6</text>
                    <text class="region-number" x="140" y="130">7</text>
                    <text class="region-number" x="55" y="55">8</text>
                    <text class="region-number" x="160" y="30" style="font-size:10px">9</text>
                    <text class="region-number" x="80" y="165" style="font-size:8px">10</text>
                    <text class="region-number" x="80" y="75" style="font-size:8px">11</text>
                    <text class="region-number" x="30" y="35" style="font-size:10px">12</text>
                    <text class="region-number" x="100" y="140" style="font-size:10px">13</text>
                </svg>`
            },
            // Level 14: Castle - 14 regions
            {
                name: "Castle",
                svg: `<svg viewBox="0 0 200 200">
                    <rect class="svg-region" data-region="9" x="10" y="10" width="180" height="40" fill="white"/>
                    <circle class="svg-region" data-region="2" cx="170" cy="30" r="10" fill="white"/>
                    <rect class="svg-region" data-region="3" x="10" y="170" width="180" height="20" fill="white"/>
                    <rect class="svg-region" data-region="10" x="50" y="90" width="100" height="80" fill="white"/>
                    <rect class="svg-region" data-region="13" x="30" y="70" width="30" height="100" fill="white"/>
                    <rect class="svg-region" data-region="13" x="140" y="70" width="30" height="100" fill="white"/>
                    <rect class="svg-region" data-region="7" x="80" y="50" width="40" height="40" fill="white"/>
                    <path d="M30 70 L45 50 L60 70" fill="white" stroke="#333" stroke-width="2"/>
                    <path d="M140 70 L155 50 L170 70" fill="white" stroke="#333" stroke-width="2"/>
                    <path class="svg-region" data-region="1" d="M45 50 L45 30 L60 35 L45 40" fill="white"/>
                    <path class="svg-region" data-region="14" d="M155 50 L155 30 L170 35 L155 40" fill="white"/>
                    <path class="svg-region" data-region="12" d="M85 170 L85 130 Q100 110 115 130 L115 170 Z" fill="white"/>
                    <rect class="svg-region" data-region="4" x="40" y="90" width="10" height="20" fill="white"/>
                    <rect class="svg-region" data-region="4" x="150" y="90" width="10" height="20" fill="white"/>
                    <rect class="svg-region" data-region="8" x="60" y="100" width="80" height="15" fill="white"/>
                    <circle class="svg-region" data-region="5" cx="45" cy="130" r="5" fill="white"/>
                    <circle class="svg-region" data-region="5" cx="155" cy="130" r="5" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="30" cy="170" r="5" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="170" cy="170" r="5" fill="white"/>
                    <rect class="svg-region" data-region="11" x="30" y="55" width="8" height="12" fill="white"/>
                    <rect class="svg-region" data-region="11" x="52" y="55" width="8" height="12" fill="white"/>
                    <rect class="svg-region" data-region="11" x="140" y="55" width="8" height="12" fill="white"/>
                    <rect class="svg-region" data-region="11" x="162" y="55" width="8" height="12" fill="white"/>
                    <text class="region-number" x="60" y="30" style="font-size:10px">1</text>
                    <text class="region-number" x="170" y="30" style="font-size:10px">2</text>
                    <text class="region-number" x="100" y="180">3</text>
                    <text class="region-number" x="45" y="100" style="font-size:8px">4</text>
                    <text class="region-number" x="45" y="130" style="font-size:8px">5</text>
                    <text class="region-number" x="30" y="165" style="font-size:8px">6</text>
                    <text class="region-number" x="100" y="70">7</text>
                    <text class="region-number" x="100" y="108" style="font-size:10px">8</text>
                    <text class="region-number" x="100" y="30">9</text>
                    <text class="region-number" x="70" y="150">10</text>
                    <text class="region-number" x="45" y="60" style="font-size:8px">11</text>
                    <text class="region-number" x="100" y="150">12</text>
                    <text class="region-number" x="35" y="140" style="font-size:8px">13</text>
                    <text class="region-number" x="170" y="40" style="font-size:8px">14</text>
                </svg>`
            },
            // Level 15: Dragon - 15 regions
            {
                name: "Dragon",
                svg: `<svg viewBox="0 0 200 200">
                    <path class="svg-region" data-region="12" d="M40 70 Q30 50 50 40" style="fill:none; stroke:#333; stroke-width:3px"/>
                    <path class="svg-region" data-region="8" d="M130 90 Q160 30 190 70 Q160 110 130 90" fill="white"/>
                    <path class="svg-region" data-region="14" d="M130 90 Q160 30 190 70" style="fill:none; stroke:#333; stroke-width:4px"/>
                    <rect class="svg-region" data-region="15" x="120" y="90" width="20" height="10" transform="rotate(-20)" fill="white"/>
                    <path class="svg-region" data-region="5" d="M140 140 Q170 140 180 170 L160 180 Q150 150 140 150" fill="white"/>
                    <ellipse class="svg-region" data-region="3" cx="110" cy="130" rx="30" ry="40" fill="white"/>
                    <ellipse class="svg-region" data-region="9" cx="100" cy="130" rx="15" ry="25" fill="white"/>
                    <circle class="svg-region" data-region="3" cx="80" cy="90" r="25" fill="white"/>
                    <circle class="svg-region" data-region="2" cx="80" cy="85" r="5" fill="white"/>
                    <path class="svg-region" data-region="7" d="M85 65 L95 45 L100 65" fill="white"/>
                    <path class="svg-region" data-region="7" d="M70 65 L60 45 L55 65" fill="white"/>
                    <path class="svg-region" data-region="4" d="M150 140 L160 130 L165 145" fill="white"/>
                    <path class="svg-region" data-region="4" d="M165 150 L175 140 L180 155" fill="white"/>
                    <path class="svg-region" data-region="1" d="M55 95 Q45 100 50 110" style="fill:none; stroke:red; stroke-width:3px"/>
                    <circle cx="50" cy="110" r="2" fill="red" stroke="none"/>
                    <path class="svg-region" data-region="13" d="M55 90 L60 95 L65 90" fill="white"/>
                    <circle class="svg-region" data-region="6" cx="95" cy="80" r="5" fill="white"/>
                    <ellipse class="svg-region" data-region="10" cx="90" cy="165" rx="5" ry="5" fill="white"/>
                    <ellipse class="svg-region" data-region="10" cx="130" cy="165" rx="5" ry="5" fill="white"/>
                    <rect class="svg-region" data-region="11" x="50" y="170" width="100" height="20" rx="5" fill="white"/>
                    <circle cx="100" cy="175" r="5" fill="white" stroke="#333" stroke-width="2"/>
                    <text class="region-number" x="50" y="115" style="font-size:10px">1</text>
                    <text class="region-number" x="80" y="85" style="font-size:8px">2</text>
                    <text class="region-number" x="125" y="130">3</text>
                    <text class="region-number" x="160" y="130" style="font-size:10px">4</text>
                    <text class="region-number" x="165" y="170">5</text>
                    <text class="region-number" x="95" y="80" style="font-size:8px">6</text>
                    <text class="region-number" x="105" y="55" style="font-size:8px">7</text>
                    <text class="region-number" x="125" y="100" style="font-size:8px">8</text>
                    <text class="region-number" x="100" y="130">9</text>
                    <text class="region-number" x="90" y="165" style="font-size:8px">10</text>
                    <text class="region-number" x="70" y="180">11</text>
                    <text class="region-number" x="40" y="50">12</text>
                    <text class="region-number" x="60" y="92" style="font-size:6px">13</text>
                    <text class="region-number" x="160" y="70">14</text>
                    <text class="region-number" x="160" y="50">15</text>
                </svg>`
            }
        ];

        // Generate unique math question based on level
        function generateQuestion(level) {
            let num1, num2, operator, answer;
            let maxAttempts = 100;
            let attempts = 0;
            let questionKey;
            
            do {
                // Progressive difficulty - steeper curve
                if (level === 1) {
                    num1 = Math.floor(Math.random() * 5) + 1;
                    num2 = Math.floor(Math.random() * 5) + 1;
                    operator = '+';
                    answer = num1 + num2;
                } else if (level === 2) {
                    num1 = Math.floor(Math.random() * 8) + 1;
                    num2 = Math.floor(Math.random() * (10 - num1)) + 1;
                    operator = '+';
                    answer = num1 + num2;
                } else if (level === 3) {
                    num1 = Math.floor(Math.random() * 10) + 1;
                    num2 = Math.floor(Math.random() * 10) + 1;
                    operator = '+';
                    answer = num1 + num2;
                } else if (level === 4) {
                    num1 = Math.floor(Math.random() * 8) + 3;
                    num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                    operator = '‚àí';
                    answer = num1 - num2;
                } else if (level === 5) {
                    num1 = Math.floor(Math.random() * 10) + 3;
                    num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                    operator = '‚àí';
                    answer = num1 - num2;
                } else if (level === 6) {
                    operator = Math.random() < 0.5 ? '+' : '‚àí';
                    if (operator === '+') {
                        num1 = Math.floor(Math.random() * 10) + 1;
                        num2 = Math.floor(Math.random() * (12 - num1)) + 1;
                        answer = num1 + num2;
                    } else {
                        num1 = Math.floor(Math.random() * 10) + 3;
                        num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                        answer = num1 - num2;
                    }
                } else if (level === 7) {
                    operator = Math.random() < 0.5 ? '+' : '‚àí';
                    if (operator === '+') {
                        num1 = Math.floor(Math.random() * 12) + 1;
                        num2 = Math.floor(Math.random() * (15 - num1)) + 1;
                        answer = num1 + num2;
                    } else {
                        num1 = Math.floor(Math.random() * 12) + 4;
                        num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                        answer = num1 - num2;
                    }
                } else if (level === 8) {
                    operator = Math.random() < 0.5 ? '+' : '‚àí';
                    if (operator === '+') {
                        num1 = Math.floor(Math.random() * 14) + 1;
                        num2 = Math.floor(Math.random() * (18 - num1)) + 1;
                        answer = num1 + num2;
                    } else {
                        num1 = Math.floor(Math.random() * 14) + 5;
                        num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                        answer = num1 - num2;
                    }
                } else {
                    operator = Math.random() < 0.5 ? '+' : '‚àí';
                    if (operator === '+') {
                        num1 = Math.floor(Math.random() * 15) + 1;
                        num2 = Math.floor(Math.random() * (20 - num1)) + 1;
                        answer = num1 + num2;
                    } else {
                        num1 = Math.floor(Math.random() * 15) + 6;
                        num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                        answer = num1 - num2;
                    }
                }
                
                questionKey = `${num1}${operator}${num2}`;
                attempts++;
            } while (askedQuestions.has(questionKey) && attempts < maxAttempts);
            
            askedQuestions.add(questionKey);
            
            return { num1, num2, operator, answer };
        }

        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'level-screen') {
                renderLevelGrid();
            }
        }

        // Render level grid
        function renderLevelGrid() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';

            const maxLevel = Math.max(1, ...Object.keys(levelProgress).map(Number), 1);
            const unlockedUpTo = Math.min(maxLevel + 1, pictures.length);

            for (let i = 1; i <= pictures.length; i++) {
                const colourIndex = i - 1;
                const colour = MASTER_PALETTE[colourIndex];
                const colourUnlocked = permanentPalette.includes(colourIndex);

                const btn = document.createElement('button');
                btn.className = 'level-btn ' + (i <= unlockedUpTo ? 'unlocked' : 'locked');

                // Show colour dot to indicate if this level's colour is unlocked
                const colourDot = colourUnlocked
                    ? `<span class="colour-dot" style="background: ${colour.hex};" title="${colour.name} unlocked!"></span>`
                    : `<span class="colour-dot locked" title="${colour.name} - not unlocked"></span>`;

                btn.innerHTML = `${i}${colourDot}<div class="stars">${getStarsHTML(levelProgress[i] || 0)}</div>`;

                if (i <= unlockedUpTo) {
                    btn.onclick = () => startLevel(i);
                }

                grid.appendChild(btn);
            }
        }

        function getStarsHTML(stars) {
            let html = '';
            for (let i = 0; i < 3; i++) {
                html += i < stars ? '‚≠ê' : '‚òÜ';
            }
            return html;
        }

        // Start level
        function startLevel(level) {
            initAudio();
            currentLevel = level;
            currentQuestion = 0;
            mistakes = 0;
            correctAnswers = 0;
            sessionUnlockedColour = false;
            askedQuestions.clear();
            questionResults = [];
            regionFillCount = {};

            const picture = pictures[currentLevel - 1];
            const newColourIndex = currentLevel - 1; // Colour index to unlock this level
            const newColour = MASTER_PALETTE[newColourIndex];
            const alreadyUnlocked = permanentPalette.includes(newColourIndex);

            document.getElementById('current-level').textContent = level;
            document.getElementById('picture-name').textContent = picture.name;
            document.getElementById('mistakes-counter').textContent = 'Mistakes: 0';

            // Show which colour can be unlocked
            if (alreadyUnlocked) {
                document.getElementById('colours-to-unlock').textContent =
                    `‚úÖ ${newColour.name} already unlocked`;
            } else {
                document.getElementById('colours-to-unlock').textContent =
                    `üé® Unlock ${newColour.name} (get all 5 correct!)`;
            }

            const timerContainer = document.getElementById('timer-container');
            timerContainer.style.display = level >= 10 ? 'block' : 'none';

            showScreen('question-screen');
            showQuestion();
        }

        // Show question
        function showQuestion() {
            const picture = pictures[currentLevel - 1];
            const question = generateQuestion(currentLevel);
            
            window.currentQuestionData = question;
            
            document.getElementById('question-text').textContent = 
                `${question.num1} ${question.operator} ${question.num2} = ?`;
            
            document.getElementById('question-num').textContent = currentQuestion + 1;

            // Show colour preview for the colour being unlocked this level
            const colourPreviewContainer = document.getElementById('colour-preview-container');
            const allUnlockedMsg = document.getElementById('all-unlocked-msg');
            const newColourIndex = currentLevel - 1;
            const newColour = MASTER_PALETTE[newColourIndex];
            const alreadyUnlocked = permanentPalette.includes(newColourIndex);

            if (!alreadyUnlocked) {
                colourPreviewContainer.style.display = 'block';
                allUnlockedMsg.style.display = 'none';
                const colourPreview = document.getElementById('colour-preview');
                colourPreview.style.backgroundColor = newColour.hex;
            } else {
                colourPreviewContainer.style.display = 'none';
                allUnlockedMsg.style.display = 'block';
                allUnlockedMsg.textContent = `${newColour.name} already unlocked! ‚úÖ`;
            }
            
            renderProgressBar();
            
            const input = document.getElementById('answer-input');
            input.value = '';
            input.focus();
            
            if (currentLevel >= 10) {
                startTimer();
            }
        }

        function renderProgressBar() {
            const bar = document.getElementById('progress-bar');
            bar.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                
                if (i < currentQuestion) {
                    const wasCorrect = questionResults[i];
                    dot.className += wasCorrect ? ' correct' : ' wrong';
                    dot.textContent = wasCorrect ? '‚úì' : '‚úó';
                } else if (i === currentQuestion) {
                    dot.className += ' current';
                    dot.textContent = i + 1;
                } else {
                    dot.textContent = i + 1;
                }
                
                bar.appendChild(dot);
            }
        }

        // Timer
        function startTimer() {
            const baseTime = Math.max(10, 15 - (currentLevel - 10));
            timeLeft = baseTime;
            updateTimerDisplay(baseTime);
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                updateTimerDisplay(baseTime);
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitAnswer(true);
                }
            }, 100);
        }

        function updateTimerDisplay(baseTime) {
            const fill = document.getElementById('timer-fill');
            const percentage = (timeLeft / baseTime) * 100;
            fill.style.width = percentage + '%';
            
            fill.className = 'timer-fill';
            if (timeLeft <= baseTime * 0.33) fill.className += ' danger';
            else if (timeLeft <= baseTime * 0.66) fill.className += ' warning';
        }

        // Submit answer
        function submitAnswer(timeout = false) {
            if (timerInterval) clearInterval(timerInterval);

            const input = document.getElementById('answer-input');
            const userAnswer = parseInt(input.value);
            const correct = !timeout && userAnswer === window.currentQuestionData.answer;

            questionResults.push(correct);

            if (correct) {
                playSound('correct');
                showFeedback('‚úì', '#4CAF50');
                correctAnswers++;
            } else {
                playSound('wrong');
                showFeedback('‚úó', '#f44336');
                mistakes++;
                document.getElementById('mistakes-counter').textContent = 'Mistakes: ' + mistakes;
            }

            currentQuestion++;

            setTimeout(() => {
                if (currentQuestion < 5) {
                    showQuestion();
                } else {
                    // All 5 questions answered - check if all correct
                    sessionUnlockedColour = (correctAnswers === 5);
                    startColouring();
                }
            }, 1000);
        }

        function showFeedback(icon, color) {
            const overlay = document.getElementById('feedback-overlay');
            const iconEl = document.getElementById('feedback-icon');
            iconEl.textContent = icon;
            iconEl.style.color = color;
            overlay.classList.add('show');
            
            setTimeout(() => overlay.classList.remove('show'), 800);
        }

        // Colouring phase
        function startColouring() {
            const picture = pictures[currentLevel - 1];
            const newColourIndex = currentLevel - 1;

            // Build available colours: permanent palette + this level's colour (if earned in session)
            availableColours = [];

            // Add colours from permanent palette (only up to current level's colours)
            for (let i = 0; i < currentLevel; i++) {
                if (permanentPalette.includes(i)) {
                    availableColours.push(i);
                }
            }

            // Add current level's colour if earned this session (all 5 correct)
            if (sessionUnlockedColour && !availableColours.includes(newColourIndex)) {
                availableColours.push(newColourIndex);
            }

            // Sort by colour index for consistent display
            availableColours.sort((a, b) => a - b);

            selectedColour = null;
            regionFillCount = {};
            window.originalAvailableColours = null; // Reset for new palette tracking

            document.getElementById('colouring-picture-name').textContent = picture.name;

            const area = document.getElementById('colouring-area');
            area.innerHTML = picture.svg;

            // Count total regions for each colour number
            const regionTotals = {};
            area.querySelectorAll('.svg-region').forEach(region => {
                const regionNum = parseInt(region.dataset.region);
                regionTotals[regionNum] = (regionTotals[regionNum] || 0) + 1;
                regionFillCount[regionNum] = 0;
            });
            window.regionTotals = regionTotals;

            // Add click handlers to regions
            area.querySelectorAll('.svg-region').forEach(region => {
                region.addEventListener('click', () => paintRegion(region));
            });

            renderPalette();

            document.getElementById('done-btn').style.display = 'none';
            document.getElementById('all-coloured-container').innerHTML = '';

            if (availableColours.length === 0) {
                document.getElementById('all-coloured-container').innerHTML =
                    '<div class="all-coloured-msg warning">üò¢ No colours available! Go back and unlock some colours first.</div>';
                document.getElementById('done-btn').style.display = 'inline-block';
            }

            showScreen('colouring-screen');
        }

        function renderPalette() {
            const palette = document.getElementById('colour-palette');
            palette.innerHTML = '';

            // Track which colours were originally available (before any were used)
            if (!window.originalAvailableColours) {
                window.originalAvailableColours = [...availableColours];
            }

            // Show all colours needed for this level (1 through currentLevel)
            for (let i = 0; i < currentLevel; i++) {
                const colour = MASTER_PALETTE[i];
                const btn = document.createElement('button');
                btn.className = 'colour-btn';

                const wasOriginallyAvailable = window.originalAvailableColours.includes(i);
                const isStillAvailable = availableColours.includes(i);

                if (isStillAvailable) {
                    // Colour is available to use
                    btn.style.backgroundColor = colour.hex;
                    btn.innerHTML = `<span class="number">${i + 1}</span>`;
                    btn.dataset.colourIndex = i;
                    btn.onclick = () => selectColour(i, btn);
                } else if (wasOriginallyAvailable) {
                    // Colour was used - show greyed out with checkmark
                    btn.style.backgroundColor = '#ccc';
                    btn.style.opacity = '0.5';
                    btn.innerHTML = `<span class="number">‚úì</span>`;
                    btn.disabled = true;
                    btn.title = `${colour.name} - Already used`;
                } else {
                    // Colour is locked - show with lock
                    btn.style.backgroundColor = '#ddd';
                    btn.style.opacity = '0.6';
                    btn.innerHTML = `<span class="number">üîí</span>`;
                    btn.disabled = true;
                    btn.title = `${colour.name} - Not unlocked yet`;
                }
                palette.appendChild(btn);
            }
        }

        function selectColour(index, btn) {
            document.querySelectorAll('.colour-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedColour = index;
            playSound('paint');
        }

        function paintRegion(region) {
            if (selectedColour === null) return;
            if (region.classList.contains('filled')) return;

            const regionNum = parseInt(region.dataset.region);

            // Check if the colour matches the region number
            if (selectedColour + 1 !== regionNum) {
                return;
            }

            // Paint just THIS region (not all with same number)
            region.style.fill = MASTER_PALETTE[selectedColour].hex;
            region.classList.add('filled');
            playSound('paint');
            
            // Track how many of this region number are filled
            regionFillCount[regionNum] = (regionFillCount[regionNum] || 0) + 1;
            
            // Check if ALL regions of this number are now filled
            if (regionFillCount[regionNum] >= window.regionTotals[regionNum]) {
                // Hide all number labels for this region
                const area = document.getElementById('colouring-area');
                area.querySelectorAll('.region-number').forEach(num => {
                    if (num.textContent == regionNum) {
                        num.classList.add('hidden');
                    }
                });
                
                // Remove colour from palette (all regions of this colour are done)
                availableColours = availableColours.filter(c => c !== selectedColour);
                selectedColour = null;
                renderPalette();
            }
            
            checkColouringComplete();
        }

        function checkColouringComplete() {
            // Check if all available colours have been used
            if (availableColours.length === 0) {
                // Count how many colours this level needs vs how many we had
                const coloursNeeded = currentLevel;
                const coloursAvailableAtStart = permanentPalette.filter(c => c < currentLevel).length + (sessionUnlockedColour ? 1 : 0);

                if (coloursAvailableAtStart >= coloursNeeded) {
                    document.getElementById('all-coloured-container').innerHTML =
                        '<div class="all-coloured-msg">üé® Perfect! All colours applied!</div>';
                } else {
                    const missing = coloursNeeded - coloursAvailableAtStart;
                    document.getElementById('all-coloured-container').innerHTML =
                        `<div class="all-coloured-msg warning">üé® ${missing} colour${missing > 1 ? 's' : ''} still locked. Go back and unlock them!</div>`;
                }
                document.getElementById('done-btn').style.display = 'inline-block';
            }
        }

        function finishColouring() {
            playSound('complete');

            const newColourIndex = currentLevel - 1;
            const newColour = MASTER_PALETTE[newColourIndex];

            let stars = 0;
            if (mistakes === 0) stars = 3;
            else if (mistakes === 1) stars = 2;
            else if (mistakes === 2) stars = 1;

            // If got all 5 correct and colour not already in permanent palette, add it
            let colourUnlocked = false;
            if (sessionUnlockedColour && !permanentPalette.includes(newColourIndex)) {
                permanentPalette.push(newColourIndex);
                colourUnlocked = true;
            }

            levelProgress[currentLevel] = Math.max(levelProgress[currentLevel] || 0, stars);
            saveProgress();

            showCelebration(stars, colourUnlocked, newColour.name);
        }

        function showCelebration(stars, colourUnlocked, colourName) {
            const completedImage = document.getElementById('completed-image');
            completedImage.innerHTML = document.getElementById('colouring-area').innerHTML;

            completedImage.querySelectorAll('.region-number').forEach(n => n.style.display = 'none');

            const starsDisplay = document.getElementById('stars-display');
            const starSpans = starsDisplay.querySelectorAll('.star');
            starSpans.forEach((span, i) => {
                span.classList.remove('earned');
                if (i < stars) {
                    setTimeout(() => span.classList.add('earned'), 300 * (i + 1));
                }
            });

            let message = '';
            if (stars === 3) {
                message = "PERFECT! Amazing job! üéâüåü";
            } else if (stars === 2) {
                message = "Great work! Almost perfect! ‚≠ê‚≠ê";
            } else if (stars === 1) {
                message = "Good job! Try again for more stars! üåü";
            } else {
                message = "Keep practicing! You'll get more stars next time! üí™";
            }

            // Add colour unlock message
            if (colourUnlocked) {
                message += `\nüé® ${colourName} unlocked!`;
            } else if (!permanentPalette.includes(currentLevel - 1)) {
                message += `\nüîí Get all 5 correct to unlock ${colourName}!`;
            }

            document.getElementById('completion-message').textContent = message;

            showScreen('celebration-screen');
        }

        function nextLevel() {
            if (currentLevel < pictures.length) {
                startLevel(currentLevel + 1);
            } else {
                alert("Congratulations! You've completed all levels! üéâ");
                showScreen('level-screen');
            }
        }

        // Save image
        function saveImage() {
            const svgElement = document.querySelector('#completed-image svg');
            const picture = pictures[currentLevel - 1];
            
            const clonedSvg = svgElement.cloneNode(true);
            clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 400;
            
            const svgData = new XMLSerializer().serializeToString(clonedSvg);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            
            const img = new Image();
            img.onload = function() {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, 400, 400);
                
                URL.revokeObjectURL(url);
                
                try {
                    canvas.toBlob(function(blob) {
                        if (blob) {
                            const link = document.createElement('a');
                            link.download = `mathbycolour-${picture.name.toLowerCase()}-level${currentLevel}.png`;
                            link.href = URL.createObjectURL(blob);
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(link.href);
                        }
                    }, 'image/png');
                } catch(e) {
                    const dataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = `mathbycolour-${picture.name.toLowerCase()}-level${currentLevel}.png`;
                    link.href = dataUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };
            
            img.onerror = function() {
                alert('Could not save image. Try downloading from a web browser.');
            };
            
            img.src = url;
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('question-screen').classList.contains('active')) {
                submitAnswer();
            }
        });

        // Initialize
        renderLevelGrid();
    </script>
</body>
</html>
